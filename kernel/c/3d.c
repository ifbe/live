#define u64 long long
double cosine(double x);
double sine(double x);
double table[158]={0.000000,0.010000,0.019999,0.029996,0.039989,0.049979,0.059964,0.069943,0.079915,0.089879,0.099833,0.109778,0.119712,0.129634,0.139543,0.149438,0.159318,0.169182,0.179030,0.188859,0.198669,0.208460,0.218230,0.227978,0.237703,0.247404,0.257081,0.266731,0.276356,0.285952,0.295520,0.305059,0.314567,0.324043,0.333487,0.342898,0.352274,0.361615,0.370920,0.380188,0.389418,0.398609,0.407760,0.416871,0.425939,0.434966,0.443948,0.452886,0.461779,0.470626,0.479426,0.488177,0.496880,0.505533,0.514136,0.522687,0.531186,0.539632,0.548024,0.556361,0.564642,0.572867,0.581035,0.589145,0.597195,0.605186,0.613117,0.620986,0.628793,0.636537,0.644218,0.651834,0.659385,0.666870,0.674288,0.681639,0.688921,0.696135,0.703279,0.710353,0.717356,0.724287,0.731146,0.737931,0.744643,0.751280,0.757843,0.764329,0.770739,0.777072,0.783327,0.789504,0.795602,0.801620,0.807558,0.813416,0.819192,0.824886,0.830497,0.836026,0.841471,0.846832,0.852108,0.857299,0.862404,0.867423,0.872355,0.877201,0.881958,0.886627,0.891207,0.895699,0.900100,0.904412,0.908633,0.912764,0.916803,0.920751,0.924606,0.928369,0.932039,0.935616,0.939099,0.942489,0.945784,0.948985,0.952090,0.955101,0.958016,0.960835,0.963558,0.966185,0.968715,0.971148,0.973485,0.975723,0.977865,0.979908,0.981854,0.983701,0.985450,0.987100,0.988652,0.990105,0.991458,0.992713,0.993868,0.994924,0.995881,0.996738,0.997495,0.998152,0.998710,0.999168,0.999526,0.999784,0.999942,1.000000};
double d=0.17,e=0.23,f=0;

static inline unsigned char inb( unsigned short port )
{
    unsigned char ret;
    asm volatile( "inb %1, %0"
                  : "=a"(ret) : "Nd"(port) );
    return ret;
}

char keyboard()
{
    char ret,temp;
    do{
        while((inb(0x64)&0x01)==0);         //阻塞
        ret=inb(0x60);
        temp=ret&0x80;
    }while(temp!=0);
    return ret;
}

double cosine(double x)
{
	int i;
	if(x<0)x=-x;

	if(x<3.141592653/2)
	{
		i=(int)(x/(3.141592653/2)*158);
		return table[157-i];
	}
	if(x<3.141592653)
	{
		return -sine(x-3.141592653);
	}
	return 0;
}


double sine(double x)
{
	int i;
        double negative=1;
        if(x<0){
                negative=-1;
                x=-x;
        }

	if(x<3.141592653/2)
	{
		i=(int)(x/(3.141592653/2)*158);
		return negative*table[i];
	}
	if(x<3.141592653)
	{
		return negative*cosine(x-3.141592653/2);
	}
	return 0;
}


void point(int x,int y,int z)
{
    u64* video=(u64*)0xa028;
    u64 base=*video;
    char* p=(char*)0xa019;
    char bpp=*p/8;

    int* address;

    address=(int*)(base+(y*1024+x)*bpp);
    *address=z;
}


void generate()
{
int* p;
int x,y,z;

for(p=(int*)0x200000;p<(int*)0x20000000;p++){*p=0x0;}

for(x=-250;x<0;x++) *(int*)(u64)(0x10000000+x*4)=(int)(256+x);
for(x=0;x<250;x++) *(int*)(u64)(0x10000000+x*4)=(int)x;

for(y=-250;y<0;y++) *(int*)(u64)(0x10000000+y*4*512)=((int)(256+y))<<8;
for(y=0;y<250;y++) *(int*)(u64)(0x10000000+y*4*512)=((int)y)<<8;

for(z=-250;z<0;z++) *(int*)(u64)(0x10000000+z*4*512*512)=((int)(256+z))<<16;
for(z=0;z<250;z++) *(int*)(u64)(0x10000000+z*4*512*512)=((int)z)<<16;

for(x=-100;x<100;x++)
{
 for(y=-100;y<100;y++)
 {
  for(z=-100;z<100;z++)
  {
   if(x+y+z==100) *(int*)(u64)(0x10000000+x*4+y*4*512+z*4*512*512)=0x7f;
   if(-x+y+z==100) *(int*)(u64)(0x10000000+x*4+y*4*512+z*4*512*512)=0x30ff;
   if(x+y-z==100) *(int*)(u64)(0x10000000+x*4+y*4*512+z*4*512*512)=0x9f0033;
  }
 }
}
}


void display()
{
	int u,v,w;
	int x,y,z;
	int color;
	int* world;
	double cd=cosine(d);
	double ce=cosine(e);
	double cf=cosine(f);
	double sd=sine(d);
	double se=sine(e);
	double sf=sine(f);

	for(v=-250;v<250;v++)
	{
		for(u=-250;u<250;u++)
		{
			color=0;
			for(w=-250;w<250;w++)
			{
			x=(int)(ce*cf*(double)u+(sd*se*cf-cd*sf)*(double)v+(sd*sf+cd*se*cf)*(double)w);

			y=(int)(ce*sf*(double)u+(cd*cf+sd*se*sf)*(double)v+(cd*se*sf-sd*cf)*(double)w);

			z=(int)(se*(double)u+sd*ce*(double)v+cd*ce*(double)w);

			if(x>-250&&x<250&&y>-250&&y<250&&z>-250&&z<250)
			{
			world=(int*)(u64)((z*512*512+y*512+x)*4+0x10000000);
			color+=*world;
			}


			}
			point(u+256,256-v,color);
		}
	}
}

void start()
{
	char in=0;

	generate();
	while(1)
	{
	display();
	in=keyboard();
	if(in==0x48)d=d+0.01;
	if(in==0x50)d=d-0.01;
	if(in==0x4d)e=e-0.01;
	if(in==0x4b)e=e+0.01;
	if(in==0x33)f=f-0.01;
	if(in==0x34)f=f+0.01;
	}
}

